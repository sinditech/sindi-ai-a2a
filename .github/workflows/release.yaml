# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path
name: Sindi AI Agent2Agent - Publish

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip running tests before deploy?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
    

jobs:
  publish:
    # if: github.event.pull_request.merged == true
    name: Release on MavenCentral
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating a release if you automate that part
      packages: write # Needed if you also push to GitHub Packages

    steps:
      - name: Step 1 - Checkout code
        uses: actions/checkout@v4

      - name: Step 2 - Set up Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '25' # Or your desired Java version
          distribution: 'temurin'
          cache: 'maven'
          # Important: This configures settings.xml for you
          # It looks for the server ID 'central' by default
          # and uses MAVEN_USERNAME/MAVEN_PASSWORD environment variables
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
      - run: |
          git config --global user.name 'Buhake Sindi'
          git config --global user.email 'buhake@gmail.com'

      - name: Step 3 - Import GPG secret key
        run: |
          cat <(echo -e "${{ secrets.MAVEN_GPG_PRIVATE_KEY }}") | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
        env:
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}

      - name: Step 4 - Set release version
        run: mvn versions:set -DnewVersion=${{ github.event.inputs.release_version }} -DgenerateBackupPoms=false

      - name: Step 5 - Confirm version
        run: mvn help:evaluate -Dexpression=project.version -q -DforceStdout

      - name: Step 6 - Publish package
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
            mvn --batch-mode deploy -DskipTests -DskipITs -Dspotless.check.skip=true -Psign -e # -P release if you use a profile for release builds
          else
            mvn clean verify deploy -P release -B -U --no-transfer-progress
          fi
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }} # Passed to the GPG plugin

      - name: Step 7 - Create Git tag for release
        run: |
          VERSION=${{ github.event.inputs.release_version }}
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
          
      - name: Step 8 - Generate CHANGELOG
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="v${{ github.event.inputs.release_version }}"

          if [ -z "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"- %s" > CHANGELOG.md
          else
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" > CHANGELOG.md
          fi

          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          cat CHANGELOG.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Step 9 - Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.release_version }}
          name: Release v${{ github.event.inputs.release_version }}
          body: |
            ${{ env.CHANGELOG }}
 